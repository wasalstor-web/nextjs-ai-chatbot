# Puck Visual Page Builder — Full Rebuild Plan

> **Source**: `puckeditor/puck` GitHub repo (`recipes/next` App Router recipe)
> **Target**: `nextjs-ai-chatbot` — Next.js 16 + React 19 + Tailwind 4 + shadcn/ui + Drizzle ORM + PostgreSQL
> **Communication**: Arabic (code in English)

---

## 1 — Current State Assessment

### What Exists (Prototype — DELETE)

| File | Issue |
|------|-------|
| `tools/puck-builder/*.tsx` (13 files) | inline styles, localStorage, no auth |
| `app/builder/**` (4 files) | no SSR, no DB, no admin guard |

### What We Want

| Feature | Current | Target |
|---------|---------|--------|
| Styling | Inline CSS | Tailwind CSS 4 + `cn()` + shadcn/ui |
| Storage | localStorage | PostgreSQL via Drizzle ORM |
| Assets | base64 inline | Vercel Blob (`@vercel/blob` ^0.24.1) |
| Auth | None | NextAuth v5 — `admin` / `super_admin` only |
| Preview | Client-only | SSR with ISR (revalidatePath) |
| Components | 7 basic | 18+ with DropZone nesting |
| Templates | Hardcoded array | DB-backed, import/export JSON |
| Snapshots | localStorage | PostgreSQL with restore |

---

## 2 — GitHub Recipe Reference

**Repo**: `puckeditor/puck` → `recipes/next/`

### Key Files Pulled

```
recipes/next/
├── puck.config.tsx          # Config + components definition
├── proxy.ts                 # Middleware rewrite /edit → /puck
├── lib/get-page.ts          # Data layer (replace fs → PostgreSQL)
├── app/
│   ├── [...puckPath]/       # Public render route (SSR + ISR)
│   │   ├── page.tsx         # generateMetadata + <Render>
│   │   └── client.tsx       # "use client" → <Render config={} data={}>
│   └── puck/
│       ├── [...puckPath]/   # Editor route
│       │   ├── page.tsx     # Load data → <Puck> editor
│       │   └── client.tsx   # <Puck onPublish={}>
│       └── api/route.ts     # POST save + revalidatePath
```

### Recipe Pattern

1. **Editor**: `/puck/[...puckPath]/page.tsx` → loads data → `<Puck config={} data={} onPublish={} />`
2. **Save API**: `/puck/api/route.ts` → POST body `{data, path}` → write DB → `revalidatePath(path)`
3. **Render**: `/[...puckPath]/page.tsx` → SSR `<Render config={} data={} />`
4. **Middleware**: rewrites `/any-page/edit` → `/puck/any-page`

---

## 3 — Target File Structure

```
nextjs-ai-chatbot/
├── lib/
│   ├── db/
│   │   ├── builder-schema.ts      # BuilderPage, BuilderAsset, BuilderSnapshot
│   │   ├── builder-queries.ts     # CRUD: pages, assets, snapshots
│   │   └── migrations/            # Auto-generated by drizzle-kit
│   └── builder/
│       ├── puck.config.tsx         # Full config with 18+ components
│       ├── components/             # Puck component implementations
│       │   ├── heading.tsx
│       │   ├── paragraph.tsx
│       │   ├── rich-text.tsx
│       │   ├── image-block.tsx
│       │   ├── button-block.tsx
│       │   ├── columns.tsx
│       │   ├── flex-layout.tsx
│       │   ├── container.tsx
│       │   ├── spacer.tsx
│       │   ├── divider.tsx
│       │   ├── card-block.tsx
│       │   ├── hero.tsx
│       │   ├── feature-grid.tsx
│       │   ├── cta-section.tsx
│       │   ├── testimonial.tsx
│       │   ├── stats-row.tsx
│       │   ├── accordion.tsx
│       │   ├── tabs-block.tsx
│       │   ├── embed.tsx
│       │   └── index.ts           # barrel export
│       ├── types.ts                # BuilderPage, BuilderAsset types
│       └── utils.ts                # slug helpers, validation
├── app/
│   ├── builder/
│   │   ├── layout.tsx              # Auth guard + Puck CSS import
│   │   ├── page.tsx                # Pages manager dashboard
│   │   ├── [slug]/
│   │   │   ├── page.tsx            # Server: load data → <EditorClient>
│   │   │   └── editor-client.tsx   # "use client" <Puck onPublish={}>
│   │   └── api/
│   │       ├── pages/
│   │       │   └── route.ts        # GET list / POST create
│   │       ├── pages/[id]/
│   │       │   └── route.ts        # GET / PUT / DELETE single page
│   │       ├── publish/
│   │       │   └── route.ts        # POST publish + revalidatePath
│   │       ├── assets/
│   │       │   └── route.ts        # POST upload (Vercel Blob)
│   │       └── snapshots/
│   │           └── route.ts        # GET list / POST create / PUT restore
│   └── p/
│       └── [...slug]/
│           ├── page.tsx            # SSR public render + ISR
│           └── render-client.tsx   # "use client" <Render>
└── drizzle.config.ts               # Updated: include builder-schema.ts
```

---

## 4 — Database Schema

### `lib/db/builder-schema.ts`

```typescript
import type { InferSelectModel } from "drizzle-orm";
import {
  boolean, integer, json, pgEnum, pgTable,
  text, timestamp, uuid, varchar,
} from "drizzle-orm/pg-core";
import { user } from "./schema";

export const pageStatusEnum = pgEnum("page_status", [
  "draft", "published", "archived"
]);

export const builderPage = pgTable("BuilderPage", {
  id:          uuid("id").primaryKey().notNull().defaultRandom(),
  title:       varchar("title", { length: 256 }).notNull(),
  slug:        varchar("slug", { length: 256 }).notNull().unique(),
  description: text("description"),
  status:      pageStatusEnum("status").notNull().default("draft"),
  data:        json("data").$type<Record<string, unknown>>().notNull().default({}),
  seo:         json("seo").$type<{
    title?: string;
    description?: string;
    ogImage?: string;
    keywords?: string[];
  }>().default({}),
  thumbnail:   text("thumbnail"),
  template:    varchar("template", { length: 64 }),
  sortOrder:   integer("sortOrder").default(0),
  createdAt:   timestamp("createdAt").notNull().defaultNow(),
  updatedAt:   timestamp("updatedAt").notNull().defaultNow(),
  publishedAt: timestamp("publishedAt"),
  creatorId:   uuid("creatorId").references(() => user.id),
});

export type BuilderPage = InferSelectModel<typeof builderPage>;

export const builderAsset = pgTable("BuilderAsset", {
  id:        uuid("id").primaryKey().notNull().defaultRandom(),
  name:      varchar("name", { length: 256 }).notNull(),
  url:       text("url").notNull(),
  type:      varchar("type", { length: 32 }).notNull(), // image, video, document
  size:      integer("size").default(0),
  mimeType:  varchar("mimeType", { length: 128 }),
  pageId:    uuid("pageId").references(() => builderPage.id, { onDelete: "set null" }),
  createdAt: timestamp("createdAt").notNull().defaultNow(),
  creatorId: uuid("creatorId").references(() => user.id),
});

export type BuilderAsset = InferSelectModel<typeof builderAsset>;

export const builderSnapshot = pgTable("BuilderSnapshot", {
  id:        uuid("id").primaryKey().notNull().defaultRandom(),
  pageId:    uuid("pageId").notNull().references(() => builderPage.id, { onDelete: "cascade" }),
  label:     varchar("label", { length: 256 }),
  data:      json("data").$type<Record<string, unknown>>().notNull(),
  createdAt: timestamp("createdAt").notNull().defaultNow(),
  creatorId: uuid("creatorId").references(() => user.id),
});

export type BuilderSnapshot = InferSelectModel<typeof builderSnapshot>;
```

---

## 5 — Puck Components (18+)

All components use **Tailwind CSS 4**, `cn()` utility, and shadcn/ui primitives.

### Layout Components (with DropZone)

| Component | Props | DropZone |
|-----------|-------|----------|
| `Container` | maxWidth, padding, bg | ✅ `content` |
| `Columns` | columns (2-4), gap | ✅ per-column zone |
| `FlexLayout` | direction, gap, align | ✅ `children` |
| `Spacer` | height (px) | — |
| `Divider` | color, thickness | — |

### Content Components

| Component | Props |
|-----------|-------|
| `Heading` | text, level (h1-h6), align |
| `Paragraph` | text, fontSize, align |
| `RichText` | html content |
| `ImageBlock` | src (Vercel Blob), alt, borderRadius |
| `ButtonBlock` | label, href, variant (shadcn), size |
| `Embed` | url (YouTube/Vimeo/HTML), aspectRatio |

### Section Components

| Component | Props | DropZone |
|-----------|-------|----------|
| `Hero` | title, subtitle, bgImage, cta | ✅ `extra` |
| `CardBlock` | title, desc, image, href | — |
| `FeatureGrid` | columns, items[] | — |
| `CTASection` | title, subtitle, buttons[] | ✅ `content` |
| `Testimonial` | quote, author, avatar | — |
| `StatsRow` | stats[] {value, label} | — |

### Interactive Components

| Component | Props |
|-----------|-------|
| `Accordion` | items[] {title, content} |
| `TabsBlock` | tabs[] {label, content} |

---

## 6 — Implementation Phases

### Phase 1: Foundation (DB + Delete Old)

```bash
# 1. Delete prototype files
rm -rf tools/puck-builder/
rm -rf app/builder/

# 2. Create schema + queries
# → lib/db/builder-schema.ts
# → lib/db/builder-queries.ts

# 3. Update drizzle.config.ts to include builder-schema
# 4. Generate + run migration
pnpm db:generate
pnpm db:migrate
```

### Phase 2: Puck Config + Components

- Create `lib/builder/puck.config.tsx` with all 18+ components
- Each component in `lib/builder/components/*.tsx`
- Uses Tailwind + cn() + shadcn primitives
- DropZone for layout components (Container, Columns, Flex, Hero, CTA)
- Root fields: title, description, ogImage (SEO)

### Phase 3: Routes + API

**Editor Routes** (`app/builder/`):
- `layout.tsx` — auth guard (admin/super_admin only) + `@puckeditor/core/puck.css`
- `page.tsx` — pages manager dashboard (list/create/delete pages)
- `[slug]/page.tsx` — load from DB → `<EditorClient>`
- `[slug]/editor-client.tsx` — `"use client"` → `<Puck config={} data={} onPublish={} />`

**API Routes** (`app/builder/api/`):
- `pages/route.ts` — GET (list all) / POST (create new page)
- `pages/[id]/route.ts` — GET / PUT / DELETE single page
- `publish/route.ts` — POST publish page + `revalidatePath`
- `assets/route.ts` — POST upload to Vercel Blob
- `snapshots/route.ts` — GET / POST / PUT (restore)

**Public Render** (`app/p/[...slug]/`):
- `page.tsx` — SSR with `generateMetadata` + ISR via `revalidatePath`
- `render-client.tsx` — `"use client"` → `<Render config={} data={} />`

### Phase 4: Proxy + Auth

**Update `proxy.ts`**:
```typescript
// Builder routes require admin auth
if (pathname.startsWith("/builder")) {
  const token = await getToken({ req: request, ... });
  if (!token || !["admin", "super_admin"].includes(token.role)) {
    return NextResponse.redirect(new URL("/", request.url));
  }
  return NextResponse.next();
}

// Public pages render (p/ prefix)
if (pathname.startsWith("/p/")) {
  return NextResponse.next();
}
```

### Phase 5: Quality Assurance

- [ ] `tsc --noEmit` → zero errors
- [ ] `pnpm build` → clean build
- [ ] RTL support (Arabic)
- [ ] Loading skeletons for pages manager
- [ ] Error boundaries
- [ ] Update all 7 agent directive files

---

## 7 — Agent Directive Files to Update

| File | What to Add |
|------|-------------|
| `CLAUDE.md` | Builder schema, routes, Puck config location |
| `AGENTS.md` | Builder module docs |
| `.cursorrules` | Builder file patterns |
| `.clinerules` | Builder context |
| `.windsurfrules` | Builder rules |
| `.ai/copilot-instructions.md` | Builder workflow |
| `APEX_AGENT.md` | Builder reference (if exists) |

---

## 8 — Drizzle Config Update

```typescript
// drizzle.config.ts
export default defineConfig({
  schema: [
    "./lib/db/schema.ts",
    "./lib/db/agents-schema.ts",
    "./lib/db/builder-schema.ts",  // ← NEW
  ],
  out: "./lib/db/migrations",
  dialect: "postgresql",
  dbCredentials: { url: process.env.POSTGRES_URL! },
});
```

---

## 9 — Key Patterns from GitHub Recipe

### Editor Client (from `puckeditor/puck/recipes/next`)

```tsx
"use client";
import type { Data } from "@puckeditor/core";
import { Puck } from "@puckeditor/core";
import config from "@/lib/builder/puck.config";

export function EditorClient({ slug, data }: { slug: string; data: Partial<Data> }) {
  return (
    <Puck
      config={config}
      data={data}
      onPublish={async (data) => {
        await fetch("/builder/api/publish", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ data, slug }),
        });
      }}
    />
  );
}
```

### Render Client (from recipe)

```tsx
"use client";
import type { Data } from "@puckeditor/core";
import { Render } from "@puckeditor/core";
import config from "@/lib/builder/puck.config";

export function RenderClient({ data }: { data: Data }) {
  return <Render config={config} data={data} />;
}
```

### Publish API (adapted from recipe)

```typescript
import { revalidatePath } from "next/cache";
import { NextResponse } from "next/server";
import { auth } from "@/app/(auth)/auth";
import { publishBuilderPage } from "@/lib/db/builder-queries";

export async function POST(request: Request) {
  const session = await auth();
  if (!session?.user || !["admin","super_admin"].includes(session.user.role)) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }

  const { data, slug } = await request.json();
  await publishBuilderPage({ slug, data });

  revalidatePath(`/p/${slug}`);
  return NextResponse.json({ status: "ok" });
}
```

---

## 10 — Execution Checklist

- [ ] Delete `tools/puck-builder/` (13 files)
- [ ] Delete `app/builder/` (4 files)
- [ ] Create `lib/db/builder-schema.ts`
- [ ] Create `lib/db/builder-queries.ts`
- [ ] Update `drizzle.config.ts` to include builder-schema
- [ ] Run `pnpm db:generate` + `pnpm db:migrate`
- [ ] Create `lib/builder/types.ts`
- [ ] Create `lib/builder/utils.ts`
- [ ] Create `lib/builder/components/*.tsx` (20 files)
- [ ] Create `lib/builder/puck.config.tsx`
- [ ] Create `app/builder/layout.tsx` (auth guard)
- [ ] Create `app/builder/page.tsx` (pages manager)
- [ ] Create `app/builder/[slug]/page.tsx`
- [ ] Create `app/builder/[slug]/editor-client.tsx`
- [ ] Create `app/builder/api/pages/route.ts`
- [ ] Create `app/builder/api/pages/[id]/route.ts`
- [ ] Create `app/builder/api/publish/route.ts`
- [ ] Create `app/builder/api/assets/route.ts`
- [ ] Create `app/builder/api/snapshots/route.ts`
- [ ] Create `app/p/[...slug]/page.tsx`
- [ ] Create `app/p/[...slug]/render-client.tsx`
- [ ] Update `proxy.ts` (admin-only builder, public /p/)
- [ ] `tsc --noEmit` → 0 errors
- [ ] `pnpm build` → clean
- [ ] Update 7 agent directive files
