/**
 * ุฃุฏุงุฉ ุชุญููู ุงูุนููุฏ - Contract Analysis Tool
 * ุชุญููู ุดุงูู ููุนููุฏ ูุงููุซุงุฆู ุงููุงููููุฉ ููู ุงููุงููู ุงูุณุนูุฏู
 */

import { tool } from "ai";
import { z } from "zod";
import { CONTRACT_REVIEW_PROMPT } from "@/lib/legal/prompts";

export const analyzeContract = tool({
  description: `ุฃุฏุงุฉ ูุชุฎุตุตุฉ ููุฑุงุฌุนุฉ ูุชุญููู ุงูุนููุฏ ูุงูุงุชูุงููุงุช ููู ุงูุฃูุธูุฉ ุงูุณุนูุฏูุฉ.

  ุงุณุชุฎุฏุงููุง ูู:
  - ุชุญููู ุจููุฏ ุงูุนูุฏ ูุชูููููุง
  - ุงูุชุดุงู ุงูุซุบุฑุงุช ูุงููุฎุงุทุฑ ุงููุงููููุฉ
  - ุงูุชุญูู ูู ุชูุงูู ุงูุนูุฏ ูุน ุงูุฃูุธูุฉ ุงูุณุนูุฏูุฉ
  - ุงูุชุฑุงุญ ุชุนุฏููุงุช ูุจููุฏ ุญูุงุฆูุฉ
  - ูุฑุงุฌุนุฉ ุงูุนููุฏ ูุจู ุงูุชูููุน

  ุฃููุงุน ุงูุนููุฏ ุงููุฏุนููุฉ:
  - ุนููุฏ ุงูุนูู
  - ุนููุฏ ุงูุจูุน ูุงูุดุฑุงุก
  - ุนููุฏ ุงูุฅูุฌุงุฑ
  - ุนููุฏ ุงูุดุฑุงูุฉ
  - ุนููุฏ ุงูุฎุฏูุงุช
  - ุนููุฏ ุงูููุงููุงุช
  - ุงูุงุชูุงููุงุช ุงูุชุฌุงุฑูุฉ`,

  inputSchema: z.object({
    contractType: z
      .enum([
        "ุนูุฏ ุนูู",
        "ุนูุฏ ุจูุน",
        "ุนูุฏ ุฅูุฌุงุฑ",
        "ุนูุฏ ุดุฑุงูุฉ",
        "ุนูุฏ ุฎุฏูุงุช",
        "ุนูุฏ ููุงููุฉ",
        "ุงุชูุงููุฉ ุชุฌุงุฑูุฉ",
        "ุนูุฏ ุขุฎุฑ",
      ])
      .describe("ููุน ุงูุนูุฏ ุงููุฑุงุฏ ุชุญูููู"),

    contractText: z
      .string()
      .describe("ูุต ุงูุนูุฏ ุฃู ุฃูู ุงูุจููุฏ ุงูุชู ูุฑูุฏ ุงููุณุชุฎุฏู ูุฑุงุฌุนุชูุง"),

    userRole: z
      .enum(["ุทุฑู ุฃูู", "ุทุฑู ุซุงูู", "ูุณุชุดุงุฑ", "ุบูุฑ ูุญุฏุฏ"])
      .optional()
      .describe("ุฏูุฑ ุงููุณุชุฎุฏู ูู ุงูุนูุฏ"),

    specificConcerns: z
      .array(z.string())
      .optional()
      .describe(`
      ุงููุฎุงูู ุฃู ุงูููุงุท ุงููุญุฏุฏุฉ ุงูุชู ูุฑูุฏ ุงููุณุชุฎุฏู ุงูุชุฑููุฒ ุนูููุง.
      ูุซุงู: ["ุงูุจูุฏ ุงูุฌุฒุงุฆู", "ุดุฑุท ุนุฏู ุงูููุงูุณุฉ", "ุฅููุงุก ุงูุนูุฏ"]
    `),

    analysisDepth: z
      .enum(["ุณุฑูุน", "ูุชูุณุท", "ุดุงูู"])
      .default("ูุชูุณุท")
      .describe(`
      ุนูู ุงูุชุญููู ุงููุทููุจ:
      - ุณุฑูุน: ูุธุฑุฉ ุนุงูุฉ ุนูู ุงูููุงุท ุงูุฑุฆูุณูุฉ
      - ูุชูุณุท: ุชุญููู ูุชูุงุฒู ููุจููุฏ ุงููููุฉ
      - ุดุงูู: ูุฑุงุฌุนุฉ ุฏูููุฉ ููู ุงูุจููุฏ ูุงูุชูุงุตูู
    `),
  }),

  execute: async ({
    contractType,
    contractText,
    userRole = "ุบูุฑ ูุญุฏุฏ",
    specificConcerns = [],
    analysisDepth,
  }) => {

    let analysis = `## ๐ ุชุญููู ${contractType}

${CONTRACT_REVIEW_PROMPT}

---

**๐ค ุฏูุฑ ุงููุณุชุฎุฏู:** ${userRole}
**๐ ูุณุชูู ุงูุชุญููู:** ${analysisDepth}

`;

    if (specificConcerns.length > 0) {
      analysis += "**โ๏ธ ููุงุท ุงูุงูุชูุงู ุงูุฎุงุตุฉ:**\n";
      for (const concern of specificConcerns) {
        analysis += `- ${concern}\n`;
      }
      analysis += "\n";
    }

    // ุชุญููู ุฃููู ูููุต
    const hasContractText = contractText && contractText.length > 50;

    if (!hasContractText) {
      analysis += `### โ๏ธ ุชูุจูู
ูู ูุชู ุชูุฏูู ูุต ูุงูู ูู ุงูุนูุฏ ููุชุญููู. ููุญุตูู ุนูู ุชุญููู ุฏูููุ ููุฑุฌู:
1. ุฅุฑูุงู ูุต ุงูุนูุฏ ูุงููุงู ุฃู ุฃูู ุงูุจููุฏ
2. ุชุญุฏูุฏ ุงูุจููุฏ ุงููุซูุฑุฉ ููููู
3. ุฐูุฑ ุฃู ุชูุงุตูู ุฅุถุงููุฉ ูููุฉ

**ูุง ูููููู ูุนูู ุงูุขู:**
- ุดุฑุญ ุงูุจููุฏ ุงูุฃุณุงุณูุฉ ุงูุชู ูุฌุจ ุฃู ูุชุถูููุง ${contractType}
- ุชูุถูุญ ุงููุฎุงุทุฑ ุงูุดุงุฆุนุฉ ูู ูุฐุง ุงูููุน ูู ุงูุนููุฏ
- ุงูุฅุฌุงุจุฉ ุนูู ุฃุณุฆูุฉ ูุญุฏุฏุฉ ุญูู ุงูุนูุฏ
`;

      return {
        status: "needs_more_info",
        contractType,
        userRole,
        analysisDepth,
        analysis,
        applicableLaws: [],
        risks: [],
        recommendations: [
          "ูุฏู ูุต ุงูุนูุฏ ุฃู ุงูุจููุฏ ุงูุฑุฆูุณูุฉ",
          "ุญุฏุฏ ุงููุฎุงูู ุงูุฎุงุตุฉ ุจู",
          "ุงุทุฑุญ ุฃุณุฆูุฉ ูุญุฏุฏุฉ",
        ],
      };
    }

    // ุชุญููู ุดุงูู
    analysis += `## ๐ ุงูุชุญููู ุงูุนุงู

### โ ููุงุท ุงูููุฉ ุงููุญุชููุฉ:
[ุณูุชู ุชุญุฏูุฏูุง ุจุนุฏ ูุฑุงุฌุนุฉ ุงููุต]

### โ๏ธ ููุงุท ุงูุถุนู ูุงููุฎุงุทุฑ:
[ุณูุชู ุชุญุฏูุฏูุง ุจุนุฏ ูุฑุงุฌุนุฉ ุงูุจููุฏ]

### ๐ ุงูุชูุงูู ูุน ุงูุฃูุธูุฉ ุงูุณุนูุฏูุฉ:
`;

    // ุชุญุฏูุฏ ุงูุฃูุธูุฉ ุงููุทุจูุฉ ุญุณุจ ููุน ุงูุนูุฏ
    const applicableLaws: Record<string, string[]> = {
      "ุนูุฏ ุนูู": [
        "ูุธุงู ุงูุนูู ุงูุณุนูุฏู",
        "ุงููุงุฆุญุฉ ุงูุชูููุฐูุฉ ููุธุงู ุงูุนูู",
        "ูุธุงู ุงูุชุฃูููุงุช ุงูุงุฌุชูุงุนูุฉ",
      ],
      "ุนูุฏ ุจูุน": ["ูุธุงู ุงููุนุงููุงุช ุงููุฏููุฉ", "ูุธุงู ุงูุชุฌุงุฑุฉ (ููุนููุฏ ุงูุชุฌุงุฑูุฉ)"],
      "ุนูุฏ ุฅูุฌุงุฑ": ["ูุธุงู ุฅูุฌุงุฑ", "ูุธุงู ุงูุชูููุฐ"],
      "ุนูุฏ ุดุฑุงูุฉ": ["ูุธุงู ุงูุดุฑูุงุช", "ูุธุงู ุงูุชุฌุงุฑุฉ"],
      "ุนูุฏ ููุงููุฉ": [
        "ูุธุงู ุงูููุงููุงุช",
        "ูุธุงู ุงูููุงูุณุงุช ูุงููุดุชุฑูุงุช ุงูุญููููุฉ (ููุนููุฏ ุงูุญููููุฉ)",
      ],
    };

    const laws = applicableLaws[contractType] || ["ูุธุงู ุงููุนุงููุงุช ุงููุฏููุฉ"];

    for (const law of laws) {
      analysis += `- ${law}\n`;
    }

    analysis += `\n## ๐ ุงูุจููุฏ ุงูุฃุณุงุณูุฉ ุงููุงุฌุจ ุชูุงูุฑูุง

`;

    // ุงูุจููุฏ ุงูุฃุณุงุณูุฉ ุญุณุจ ููุน ุงูุนูุฏ
    const essentialClauses: Record<string, string[]> = {
      "ุนูุฏ ุนูู": [
        "โ ุจูุงูุงุช ุงูุทุฑููู (ุตุงุญุจ ุงูุนูู ูุงูุนุงูู)",
        "โ ููุน ุงูุนูุฏ (ูุญุฏุฏ ุงููุฏุฉ ุฃู ุบูุฑ ูุญุฏุฏ)",
        "โ ุชุงุฑูุฎ ุจุฏุก ุงูุนูู",
        "โ ุงูุฑุงุชุจ ูุงูุจุฏูุงุช",
        "โ ุงูุฅุฌุงุฒุงุช ุงูุณูููุฉ",
        "โ ุณุงุนุงุช ุงูุนูู",
        "โ ููุงู ุงูุนูู",
        "โ ุงูููุงู ุงููุธูููุฉ",
        "โ ูุชุฑุฉ ุงูุชุฌุฑุจุฉ (ุฅู ูุฌุฏุช)",
        "โ ุดุฑูุท ุฅููุงุก ุงูุนูุฏ",
      ],
      "ุนูุฏ ุฅูุฌุงุฑ": [
        "โ ุจูุงูุงุช ุงููุคุฌุฑ ูุงููุณุชุฃุฌุฑ",
        "โ ูุตู ุงูุนูู ุงููุคุฌุฑุฉ",
        "โ ูุฏุฉ ุงูุฅูุฌุงุฑ",
        "โ ูููุฉ ุงูุฅูุฌุงุฑ ูุทุฑููุฉ ุงูุณุฏุงุฏ",
        "โ ุงูุบุฑุถ ูู ุงูุฅูุฌุงุฑ",
        "โ ุงูุชุฒุงูุงุช ูู ุทุฑู",
        "โ ุดุฑูุท ุงูุชุฌุฏูุฏ",
        "โ ุงูุชุฃููู (ุฅู ูุฌุฏ)",
        "โ ุดุฑูุท ุงูุฅุฎูุงุก",
      ],
      "ุนูุฏ ุจูุน": [
        "โ ุจูุงูุงุช ุงูุจุงุฆุน ูุงููุดุชุฑู",
        "โ ูุตู ุงููุจูุน ุจุฏูุฉ",
        "โ ุงูุซูู ูุทุฑููุฉ ุงูุณุฏุงุฏ",
        "โ ุชุงุฑูุฎ ุงูุชุณููู",
        "โ ููุงู ุงูุชุณููู",
        "โ ุงูุถูุงูุงุช (ุฅู ูุฌุฏุช)",
        "โ ููู ุงูููููุฉ ูุงููุฎุงุทุฑ",
        "โ ุงูุดุฑูุท ุงูุฌุฒุงุฆูุฉ (ุฅู ูุฌุฏุช)",
      ],
    };

    const clauses = essentialClauses[contractType] || [
      "โ ุจูุงูุงุช ุงูุฃุทุฑุงู",
      "โ ููุถูุน ุงูุนูุฏ",
      "โ ุงูุงูุชุฒุงูุงุช ูุงูุญููู",
      "โ ุงููุฏุฉ",
      "โ ุงูููุงุจู ุงููุงูู",
      "โ ุดุฑูุท ุงูุฅููุงุก",
    ];

    for (const clause of clauses) {
      analysis += `${clause}\n`;
    }

    analysis += `\n## โ๏ธ ุงููุฎุงุทุฑ ุงููุงููููุฉ ุงููุญุชููุฉ

`;

    // ูุฎุงุทุฑ ุดุงุฆุนุฉ
    const commonRisks = [
      "โ ุจููุฏ ุบุงูุถุฉ ุฃู ูุงุจูุฉ ููุชุฃููู",
      "โ ุบูุงุจ ุขููุฉ ูุงุถุญุฉ ูุญู ุงููุฒุงุนุงุช",
      "โ ุดุฑูุท ุฌุฒุงุฆูุฉ ูุจุงูุบ ูููุง",
      "โ ุจููุฏ ุชุฎุงูู ุงููุธุงู ุฃู ุงูุดุฑูุนุฉ",
      "โ ุนุฏู ุชุญุฏูุฏ ุงูุงุฎุชุตุงุต ุงููุถุงุฆู",
      "โ ุบูุงุจ ุจููุฏ ุงููุณุฎ ุฃู ุงูุฅููุงุก ุงููุจูุฑ",
    ];

    for (const risk of commonRisks) {
      analysis += `${risk}\n`;
    }

    analysis += `\n## ๐ก ุงูุชูุตูุงุช ูุงูุชุนุฏููุงุช ุงูููุชุฑุญุฉ

`;

    if (analysisDepth === "ุดุงูู") {
      analysis += `### ๐ ุจููุฏ ููุชุฑุญุฉ ููุฅุถุงูุฉ:
1. ุจูุฏ ุญู ุงููุฒุงุนุงุช (ุงูุชุญููู ุฃู ุงููุถุงุก)
2. ุจูุฏ ุงูููุฉ ุงููุงูุฑุฉ ูุงูุธุฑูู ุงูุทุงุฑุฆุฉ
3. ุจูุฏ ุงูุณุฑูุฉ (ุฅู ูุงู ููุงุณุจุงู)
4. ุจูุฏ ุนุฏู ุงูุชูุงุฒู ููุบูุฑ ุฏูู ููุงููุฉ
5. ุจูุฏ ุงูุชุนุฏููุงุช ุงููุณุชูุจููุฉ

### โ๏ธ ุจููุฏ ุชุญุชุงุฌ ูุฑุงุฌุนุฉ ุฏูููุฉ:
- ุงูุจููุฏ ุงูุฌุฒุงุฆูุฉ (ูุฌุจ ุฃู ุชููู ูุนูููุฉ)
- ุดุฑูุท ุนุฏู ุงูููุงูุณุฉ (ูุฌุจ ุฃู ุชููู ูุญุฏูุฏุฉ ุฒูููุงู ูููุงููุงู)
- ุจููุฏ ุงูุฅููุงุก (ูุฌุจ ุฃู ุชููู ูุชูุงุฒูุฉ)

### ๐ง ุชุนุฏููุงุช ูุบููุฉ ููุชุฑุญุฉ:
- ุงุณุชุฎุฏุงู ูุบุฉ ูุงุถุญุฉ ููุญุฏุฏุฉ
- ุชุฌูุจ ุงููุตุทูุญุงุช ุงูุบุงูุถุฉ
- ุชุญุฏูุฏ ุงูุฃุฑูุงู ูุงูููุงุนูุฏ ุจุฏูุฉ

`;
    }

    analysis += `\n## โ ุงูุฎุทูุงุช ุงูุชุงููุฉ ุงูููุชุฑุญุฉ

1. **ุงููุฑุงุฌุนุฉ ุงูุฏุงุฎููุฉ:**
   - ูุฑุงุกุฉ ุงูุนูุฏ ูุงููุงู ุจุชุฃูู
   - ุชุญุฏูุฏ ุฃู ุจููุฏ ุบูุฑ ูุงุถุญุฉ
   - ููุงุฑูุฉ ูุน ุนููุฏ ูุดุงุจูุฉ (ุฅู ูุฌุฏุช)

2. **ุงูุงุณุชุดุงุฑุฉ ุงููุงููููุฉ:**
   - ุนุฑุถ ุงูุนูุฏ ุนูู ูุญุงูู ูุฑุฎุต ูุจู ุงูุชูููุน
   - ููุงูุดุฉ ุฃู ุจููุฏ ูุซูุฑุฉ ููููู

3. **ุงูุชูุงูุถ:**
   - ุทูุจ ุชุนุฏูู ุงูุจููุฏ ุงูุฅุดูุงููุฉ
   - ุฅุถุงูุฉ ุจููุฏ ุญูุงุฆูุฉ
   - ุชูุถูุญ ุงูููุงุท ุงูุบุงูุถุฉ

4. **ุงูุชูุซูู:**
   - ุงูุชุฃูุฏ ูู ุชูุซูู ุงูุนูุฏ ูุฏู ุงูุฌูุฉ ุงููุฎุชุตุฉ
   - ุงูุงุญุชูุงุธ ุจูุณุฎุฉ ููุซูุฉ

`;

    analysis += `\n---

โ๏ธ **ุฅุฎูุงุก ูุณุคูููุฉ ูุงูููู:**
ูุฐุง ุงูุชุญููู ุงุณุชุฑุดุงุฏู ูููุณ ุจุฏููุงู ุนู ุงููุดูุฑุฉ ุงููุงููููุฉ ุงููุชุฎุตุตุฉ. ูููุตุญ ุจุดุฏุฉ ุจุงุณุชุดุงุฑุฉ ูุญุงูู ูุฑุฎุต ูุจู ุชูููุน ุฃู ุนูุฏ ุฃู ุงูุชุฒุงู ูุงูููู.

๐ **ููุญุตูู ุนูู ูุดูุฑุฉ ูุงููููุฉ ููุฒูุฉ:**
- ุงุณุชุดุฑ ูุญุงููุงู ูุฑุฎุตุงู ูู ูุฒุงุฑุฉ ุงูุนุฏู
- ุชูุงุตู ูุน ููุฆุฉ ุงููุญุงููู ุงูุณุนูุฏููู
- ุงุณุชุฎุฏู ููุตุฉ "ุจูุฏู" ููุงุณุชุดุงุฑุงุช ุงููุงููููุฉ ุงูุฑุณููุฉ ุงููุฌุงููุฉ
`;

    return {
      status: "success",
      contractType,
      userRole,
      analysisDepth,
      analysis,
      applicableLaws: laws,
      risks: commonRisks.slice(0, 3), // ุนููุฉ ูู ุงููุฎุงุทุฑ
      recommendations: [
        "ูุฑุงุฌุนุฉ ูุญุงูู ูุจู ุงูุชูููุน",
        "ุงูุชุฃูุฏ ูู ุฌููุน ุงูุจููุฏ ุงูุฃุณุงุณูุฉ",
        "ุชูุซูู ุงูุนูุฏ ุฑุณููุงู",
        "ุงูุงุญุชูุงุธ ุจูุณุฎุฉ ููุซูุฉ",
      ],
    };
  },
});
