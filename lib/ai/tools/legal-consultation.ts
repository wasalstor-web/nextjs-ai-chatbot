/**
 * ุฃุฏุงุฉ ุงูุงุณุชุดุงุฑุงุช ุงููุงููููุฉ - Legal Consultation Tool
 * ุชุณุงุนุฏ ูู ุฌูุน ุงููุนูููุงุช ุงููุงููููุฉ ูุชูุฏูู ุงูุงุณุชุดุงุฑุงุช ุงููุชุฎุตุตุฉ
 */

import { tool } from "ai";
import { z } from "zod";
import { getIntakeQuestions } from "@/lib/legal/intake";
import { CONSULTATION_TYPE_PROMPTS } from "@/lib/legal/prompts";
import type { ConsultationType } from "@/lib/legal/types";

export const legalConsultation = tool({
  description: `ุฃุฏุงุฉ ูุชูุฏูู ุงูุงุณุชุดุงุฑุงุช ุงููุงููููุฉ ุงููุชุฎุตุตุฉ ูู ุงููุงููู ุงูุณุนูุฏู.

  ุงุณุชุฎุฏู ูุฐู ุงูุฃุฏุงุฉ ุนูุฏูุง:
  - ูุทูุจ ุงููุณุชุฎุฏู ุงุณุชุดุงุฑุฉ ูุงููููุฉ
  - ูุญุชุงุฌ ุงููุณุชุฎุฏู ูููู ููููู ุงููุงูููู
  - ูุฑูุฏ ูุนุฑูุฉ ุญูููู ูุงูุชุฒุงูุงุชู
  - ูุญุชุงุฌ ูุดุฑุญ ุฅุฌุฑุงุกุงุช ูุงููููุฉ

  ุงูุฃููุงุน ุงููุชุงุญุฉ:
  - ุนูุงุฑู: ูุฒุงุนุงุช ุงูุฅูุฌุงุฑุ ุงูุจูุนุ ุงูุฑูู
  - ุนูู: ุนููุฏ ุงูุนููุ ุงููุตูุ ุงูููุงูุขุช
  - ุชุฌุงุฑู: ุงูุดุฑูุงุชุ ุงูุนููุฏ ุงูุชุฌุงุฑูุฉ
  - ุฌุฒุงุฆู: ุงููุถุงูุง ุงูุฌูุงุฆูุฉ
  - ุฃุณุฑู: ุงูุทูุงูุ ุงูุญุถุงูุฉุ ุงููููุฉ
  - ุฅุฏุงุฑู: ุงููุฑุงุฑุงุช ุงูุฅุฏุงุฑูุฉุ ุงููุธููุฉ ุงูุนุงูุฉ
  - ููููุฉ ููุฑูุฉ: ุงูุนูุงูุงุช ุงูุชุฌุงุฑูุฉุ ุจุฑุงุกุงุช ุงูุงุฎุชุฑุงุน
  - ุงุณุชุซูุงุฑ: ุชุฑุงุฎูุต ุงูุงุณุชุซูุงุฑุ ุงููุฒุงุนุงุช`,

  inputSchema: z.object({
    consultationType: z
      .enum([
        "ุนูุงุฑู",
        "ุนูู",
        "ุชุฌุงุฑู",
        "ุฌุฒุงุฆู",
        "ุฃุณุฑู",
        "ุฅุฏุงุฑู",
        "ููููุฉ ููุฑูุฉ",
        "ุงุณุชุซูุงุฑ",
      ])
      .describe("ููุน ุงูุงุณุชุดุงุฑุฉ ุงููุงููููุฉ ุงููุทููุจุฉ"),

    userQuery: z.string().describe("ูุตู ุงูุญุงูุฉ ุฃู ุงูุณุคุงู ุงููุงูููู ูู ุงููุณุชุฎุฏู"),

    collectedInfo: z
      .record(z.string(), z.string())
      .optional()
      .describe(`
      ุงููุนูููุงุช ุงูุชู ุชู ุฌูุนูุง ูู ุงููุณุชุฎุฏู ุญุชู ุงูุขู.
      ูุซุงู: { "ุชุงุฑูุฎ_ุงููุงูุนุฉ": "2024-01-15", "ูุจูุบ_ุงููุฒุงุน": "50000" }
    `),

    stage: z
      .enum(["intake", "analysis", "recommendation"])
      .default("intake")
      .describe(`
      ูุฑุญูุฉ ุงูุงุณุชุดุงุฑุฉ:
      - intake: ุฌูุน ุงููุนูููุงุช (ุทุฑุญ ุฃุณุฆูุฉ)
      - analysis: ุชุญููู ุงููููู ุงููุงูููู
      - recommendation: ุชูุฏูู ุงูุชูุตูุงุช ุงูููุงุฆูุฉ
    `),
  }),

  execute: async ({
    consultationType,
    userQuery,
    collectedInfo = {},
    stage,
  }) => {
    // ุฌูุจ ุงูุฃุณุฆูุฉ ุงููุทููุจุฉ ููุฐุง ุงูููุน ูู ุงูุงุณุชุดุงุฑุฉ
    const questions = getIntakeQuestions(consultationType as ConsultationType);

    // ุญุณุงุจ ูุณุจุฉ ุงูุชูุงู ุงููุนูููุงุช
    const totalQuestions = questions.length;
    const answeredQuestions = Object.keys(collectedInfo).length;
    const completionPercentage = Math.round(
      (answeredQuestions / totalQuestions) * 100
    );

    // ุจูุงุก ุงูุฑุฏ ุญุณุจ ุงููุฑุญูุฉ
    let response = "";
    let nextSteps: string[] = [];

    if (stage === "intake") {
      // ูุฑุญูุฉ ุฌูุน ุงููุนูููุงุช
      response = `## ๐ ุงุณุชุดุงุฑุฉ ${consultationType}

**ุญุงูุฉ ุฌูุน ุงููุนูููุงุช:** ${completionPercentage}% ููุชูู (${answeredQuestions}/${totalQuestions})

`;

      // ุฅูุฌุงุฏ ุฃูู ุณุคุงู ุบูุฑ ููุฌุงุจ
      const unansweredQuestion = questions.find((q) => !collectedInfo[q.id]);

      if (unansweredQuestion && completionPercentage < 80) {
        response += `**${unansweredQuestion.question}**\n\n`;

        if (
          unansweredQuestion.options &&
          unansweredQuestion.options.length > 0
        ) {
          response += "ุงูุฎูุงุฑุงุช ุงููุชุงุญุฉ:\n";
          unansweredQuestion.options.forEach((opt, idx) => {
            response += `${idx + 1}. ${opt}\n`;
          });
        }

        if (unansweredQuestion.hint) {
          response += `\n๐ก _${unansweredQuestion.hint}_\n`;
        }

        nextSteps = ["ุงูุชุธุงุฑ ุฅุฌุงุจุฉ ุงููุณุชุฎุฏู"];
      } else {
        // ุงููุนูููุงุช ูุงููุฉุ ุงูุงูุชูุงู ููุชุญููู
        response += "โ ุชู ุฌูุน ุงููุนูููุงุช ุงูุฃุณุงุณูุฉ.\n\n";
        response += "ุณุฃููู ุงูุขู ุจุชุญููู ููููู ุงููุงูููู...\n";
        nextSteps = ["ุงูุงูุชูุงู ููุฑุญูุฉ ุงูุชุญููู"];
      }
    } else if (stage === "analysis") {
      // ูุฑุญูุฉ ุงูุชุญููู
      const specializedPrompt =
        CONSULTATION_TYPE_PROMPTS[consultationType as ConsultationType];

      response = `## โ๏ธ ุงูุชุญููู ุงููุงูููู - ${consultationType}

${specializedPrompt}

**๐ ููุฎุต ุงูุญุงูุฉ:**
${userQuery}

**๐ ุงููุนูููุงุช ุงููุฌููุนุฉ:**
`;

      for (const [key, value] of Object.entries(collectedInfo)) {
        response += `- **${key}**: ${value}\n`;
      }

      response += `
**๐ ุงูุฃูุธูุฉ ูุงูููุงุฆุญ ุฐุงุช ุงูุตูุฉ:**
[ุณูุชู ุชุญุฏูุฏูุง ุจูุงุกู ุนูู ุงูุญุงูุฉ]

**โ๏ธ ููุงุท ูููุฉ:**
- ูุฐุง ุงูุชุญููู ุงุณุชุฑุดุงุฏู ูููุณ ุจุฏููุงู ุนู ุงููุดูุฑุฉ ุงููุงููููุฉ ุงูููุฒูุฉ
- ูููุตุญ ุจุงุณุชุดุงุฑุฉ ูุญุงูู ูุฑุฎุต ููุญุตูู ุนูู ุฑุฃู ูุงูููู ุฑุณูู
- ุงููุฏุฏ ุงููุงููููุฉ ูููุฉ ููุฌุจ ุนุฏู ุชุฌุงูุฒูุง

`;

      nextSteps = ["ุชูุฏูู ุงูุชูุตูุงุช ูุงูุฎูุงุฑุงุช ุงููุชุงุญุฉ"];
    } else {
      // ูุฑุญูุฉ ุงูุชูุตูุงุช
      response = `## ๐ผ ุงูุชูุตูุงุช ุงููุงููููุฉ

**โ ุงูุฎูุงุฑุงุช ุงููุชุงุญุฉ:**

1. **ุงูุญู ุงููุฏู (ุงูุตูุญ):**
   - โ ุฃุณุฑุน ูุฃูู ุชูููุฉ
   - โ ูุญูุธ ุงูุนูุงูุงุช
   - โ ูุฏ ูุง ูุญูู ูุงูู ุงูุญููู

2. **ุงููุฌูุก ูููุถุงุก:**
   - โ ุญู ููุฒู ูุงูููุงู
   - โ ูุญูุธ ุฌููุน ุงูุญููู
   - โ ูุณุชุบุฑู ููุชุงู ุฃุทูู
   - โ ุชูุงููู ูุถุงุฆูุฉ ูุฃุชุนุงุจ ูุญุงูุงุฉ

3. **ุงูุชุญููู (ุฅู ูุฌุฏ ุดุฑุท ุชุญููู):**
   - โ ุฃุณุฑุน ูู ุงููุถุงุก
   - โ ุฎุตูุตูุฉ ุฃูุจุฑ
   - โ ุชูููุฉ ุงูุชุญููู

**๐ ุงูุฅุฌุฑุงุกุงุช ุงูููุชุฑุญุฉ:**
1. ุฌูุน ูุงูุฉ ุงููุณุชูุฏุงุช ุงูุฏุงุนูุฉ
2. ูุญุงููุฉ ุงูุชูุงุตู ุงููุฏู ูุน ุงูุทุฑู ุงูุขุฎุฑ
3. ุฅุฑุณุงู ุฅูุฐุงุฑ ุฑุณูู ุนุจุฑ ูุชุงุจุฉ ุงูุนุฏู (ุฅู ูุฒู)
4. ุฑูุน ุงูุฏุนูู ุงููุถุงุฆูุฉ ุฅุฐุง ูุดูุช ุงูุญููู ุงููุฏูุฉ

**โฐ ุงููุฏุฏ ุงููุงููููุฉ ุงููููุฉ:**
[ุชุญุฏุฏ ุญุณุจ ููุน ุงููุถูุฉ]

**๐ฐ ุงูุชูุงููู ุงููุชููุนุฉ:**
- ุฑุณูู ูุถุงุฆูุฉ: [ุญุณุจ ููุน ุงูุฏุนูู]
- ุฃุชุนุงุจ ูุญุงูุงุฉ: [ุชุฎุชูู ุญุณุจ ุงููุญุงูู]
- ุฑุณูู ุชูููุฐ: [ุฅู ูุฒู]

`;

      nextSteps = ["ูุชุงุจุนุฉ ุงูุญุงูุฉ", "ุงูุฅุฌุงุจุฉ ุนูู ุฃู ุงุณุชูุณุงุฑุงุช ุฅุถุงููุฉ"];
    }

    return {
      status: "success",
      consultationType,
      stage,
      completionPercentage,
      response,
      collectedInfo,
      nextSteps,
      legalDisclaimer:
        "โ๏ธ ุฅุฎูุงุก ูุณุคูููุฉ: ูุฐู ุงููุนูููุงุช ููุงุณุชุฑุดุงุฏ ุงูุนุงู ููุท ููุง ุชูุนุฏ ุงุณุชุดุงุฑุฉ ูุงููููุฉ ุฑุณููุฉ. ูููุตุญ ุจุงูุชูุงุตู ูุน ูุญุงูู ูุฑุฎุต ููุญุตูู ุนูู ูุดูุฑุฉ ูุงููููุฉ ููุฒูุฉ.",
    };
  },
});
